[gcode_macro PURGE_SCRUB]
variable_min_purge_x: 260
variable_max_purge_x: 290
variable_scrub_height: 2
variable_safe_height: 10
variable_purge_temp_min: 190
gcode:
    SAVE_GCODE_STATE NAME=clean_nozzle
    
    {% set delta_x = (max_purge_x | int) - (min_purge_x | int) %}

    G90
    G0 X260 Y300 Z30 F6000	; Move above purge bucket
    G0 X{(min_purge_x | int) + (range(delta_x) | random)}
    G0           Z{scrub_height}  F6000	; Lower to brush height
    
    {% if printer.extruder.temperature >= purge_temp_min %}
      G92 E0			; Reset extruder to 0
      G1 E15 F200			; Purge 15mm 
      G1 E13 F200			; Retract 2mm for oozing
      G4 P2000			; Wait 2s
      G92 E0			; Reset extruder to 0
    {% endif %}

    G0 X255      Z{safe_height}   F6000	; Lift and move away
    G0           Z{scrub_height}  F6000	; Lower to brush
    G0 X210          F6000	; Partially scrub left
    {% for wipes in range(1, 5) %}
      G0 X230          F3200	; Scrub right
      G0 X210          F3200  ; Scrub left
    {% endfor %}

    G0 X180          F3200	; scrub left off brush
    G0           Z{safe_height} F6000	; Move up and center

    RESTORE_GCODE_STATE NAME=clean_nozzle
